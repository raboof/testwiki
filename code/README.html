<html>
<head>
  <link rel="stylesheet" type="text/css" href="css/wiki.css">
  <script type="text/javascript" src="js/hocon.min.js"></script>
</head>
<body onload="load()">
<section class="header">
serverless-wiki
</section>
<section style="text-align: right; padding: 20px">
<a id="loginlink" href="#" onclick="document.getElementById('login').style.display = 'block'">Log in</a>
<span id="loggedin"></span>
<a id="logoutlink" href="#" onclick="logout()" style="display: none">Log out</a>
<form id="login" onsubmit="login()" style="display: none">
  Username: <input id="username" type="text"><br>
  Password: <input id="password" type="password"><br>
  <input type="submit"/>
</form>
</section>
<script>
function load() {
  const userStr = localStorage.getItem("user")
  if (userStr) {
    user = JSON.parse(userStr);
    document.getElementById('loginlink').style.display = 'none';
    document.getElementById('logoutlink').style.display = 'inline';
    document.getElementById('loggedin').style.display = 'inline';
    document.getElementById('loggedin').innerHTML = user.full_name;
  } else {
    document.getElementById('loginlink').style.display = 'inline';
    document.getElementById('logoutlink').style.display = 'none';
    document.getElementById('loggedin').style.display = 'none';
  }
  document.getElementById('login').style.display = 'none';
}
function lightHash(password) {
  let result = 0;
  for (c in password) {
    result = (result + password.charCodeAt(c)) % 100;
  }
  return result;
}

function get(url, cb, err_cb) {
  var r = new XMLHttpRequest();
  r.onreadystatechange = function() {
    if (r.readyState == 4) {
      if (r.status == 200)
        cb(r.responseText);
      else
        err_cb(r.status, r.responseText);
    }
  }
  r.open("GET", url);
  r.send();
}

function logout() {
  localStorage.setItem("user", "");
  load();
}

function login() {
  var username = document.getElementById('username').value;
  var password = document.getElementById('password').value;
  get('users/' + username + '.hocon',
    function(hoconConfig) {
      const config = parseHocon(hoconConfig);
      if (lightHash(password) == config.password_light_hash) {
        localStorage.setItem("user", JSON.stringify(config));
        load();
      } else {
        alert("Wrong password");
      }
    },
    function(status, text) {
      alert("Sorry", status, text);
    }
  )
}
</script>
<p>Serverless-wiki is a 'serverless' public wiki</p>

<p>This means most of the functionality can be accessed while
serving static pages from a CDN, and only for updates is any
server-side code required.</p>

<p>In a nutshell:</p>

<ul>
<li>Pages are mostly static and served from a CDN (e.g. github pages)</li>
<li>Page sources are stored as markdown in a git repository (e.g. github)</li>
<li>Logging in stores your password in your browser, and checks whether your
password is 'plausible' (based on a high-collision hash)</li>
<li>Update pages with an authenticated POST with new markdown, which:
<ul>
<li>commits the new markdown to the git repo</li>
<li>generates new HTML and commit it to the CDN</li>
</ul></li>
</ul>

<h2>Authentication</h2>

<p>'logging in' is initially a usability feature rather than a security feature:
the password is put though a non-cryptographic, high-collision hash function.</p>

<p>The 'real' authentication happens when POSTing new markdown.</p>

<h2>HTML generation</h2>

<p>The actual HTML generation takes wiki templates and markdown sources
as input, and generates HTML output.</p>

<p>We expect a low throughput (after all we hope to be mostly serverless,
so also keep Lambda invocations to a minimum), so we'd like a platform
that has fast cold start times. While the JDK can be a fine choice for
high-throughput Lambda functions, it might not be great for us. Nodejs
and python are comparable, and given that choice I prefer python.</p>

</body>
</html>
